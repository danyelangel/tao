/*! tao 26-08-2015 */
"use strict";function Tao(a,b){function c(){return"string"!=typeof a.name||a.name.length<4?(g("name"),!1):"string"!=typeof a.url||a.url.length<10?(g("url"),!1):"string"!=typeof a.id||20!=a.id.length?(g("id"),!1):!0}function d(a){a.map(function(a){q.child(a).onDisconnect().remove()})}function e(a){var b=a.child("input").val(),c=a.child("output").val();r._outputRef=new Firebase(o+"/channels/"+c),r._inputRef=new Firebase(o+"/channels/"+b),r.onReadyCallback(a.val())}function f(a){a.val()&&(b.api(q.child("api"),a.val()),m.set(a.val()))}function g(a){console.log("*** TaoConnect has encountered an error: "+a+" ***")}function h(a,b){var c,d={};for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(d[c]=a[c]);for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(d[c]=b[c]);return d}function i(a){q.once("value",a)}function j(a){r.onReadyCallback=a}function k(a){function b(){"input"==t?m=r._inputRef.child(u).child(s):"output"==t&&(m=r._outputRef.child(u).child(s)),n=q.child("channels").child(t).child(s),c(),n.child("enabled").on("value",function(a){var b=a.val()?"enabled":"disabled";console.log("Channel "+t+" "+s+" "+b),a.val()?c():d()}),m.child("enabled").on("value",function(a){if(a.val()==k)a.val()?c():d();else{var b=a.val()?"enabled":"disabled";console.log("Channel "+b+": "+t+" "+s)}})}function c(){k=!0,n.child("enabled").set(!0),m.child("enabled").set(!0)}function d(){k=!1,n.child("enabled").set(!1),m.child("enabled").set(!1)}function e(){return k}function f(a){var b=function(b){if(e){var c=b.val();console.log("Data read from "+t+" "+s+": "+c),a(c)}else a(l)};m.child("data").once("value",b)}function g(a){var b=function(b){console.log("Datachange event. Channel enabled: "+e()),e()&&a(b.val()),m.child("data").remove()};m.child("data").on("value",b)}function i(){m.child("data").off("value")}function j(a){e()?m.child("data").set(a):console.log("Could not set data. Channel is disabled.")}var k,l,m,n,o={dataFormat:"midi"},p=h(o,a),s=p.name,t=p.type,u=p.dataFormat;this.setData=j,this.disconnect=i,this.getData=f,this.enable=c,this.disable=d,this.isEnabled=e,this.watch=g,b(),f(function(a){l=a})}function l(a,b){function c(a){g.child("statusLog").child((new Date.now).toDateString()).set(a)}function d(a){a&&(g.child("status").set(a),g.child("statusDescription").set(f.statusMessages[a]?f.statusMessages[a]:"Unknown status"),f.logEnabled&&c(a))}var e={statusMessages:{},logEnabled:!0},f=h(e,b),g=q.child("moduleStatus").child(a);this.set=d}var m,n=a.name,o=a.url,p=a.id,q=new Firebase(o+"/metadata/"+p),r={};return function(){return c()?(m=new l(b.name,b.statusMessages),q.child("name").set(n),q.child("isTurnedOn").set(!0),d(["isTurnedOn","moduleStatus"]),q.once("value",e),void q.child("api").on("value",f)):!1}(),r.getMetadata=i,r.onReady=j,r.Channel=k,r.Status=l,r}Tao.VERSION="0.0.1";