/*! tao 26-08-2015 */
"use strict";function Tao(a,b){function c(){return"string"!=typeof a.name||a.name.length<4?(g("name"),!1):"string"!=typeof a.url||a.url.length<10?(g("url"),!1):"string"!=typeof a.id||20!=a.id.length?(g("id"),!1):!0}function d(a){a.map(function(a){r.child(a).onDisconnect().remove()})}function e(a){var b=a.child("input").val(),c=a.child("output").val();s._outputRef=new Firebase(p+"/channels/"+c),s._inputRef=new Firebase(p+"/channels/"+b),s.onReadyCallback(a.val()),n=new l("tao",{})}function f(a){a.val()&&(b.api(r.child("api"),a.val()),m.set(a.val()))}function g(a){console.log("*** TaoConnect has encountered an error: "+a+" ***")}function h(a,b){var c,d={};for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(d[c]=a[c]);for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(d[c]=b[c]);return d}function i(a){r.once("value",a)}function j(a){s.onReadyCallback=a}function k(a){function b(){"input"==t?m=s._inputRef.child(u).child(q):"output"==t&&(m=s._outputRef.child(u).child(q)),n=r.child("channels").child(t).child(q),c(),n.child("enabled").on("value",function(a){var b=a.val()?"enabled":"disabled";console.log("Channel "+t+" "+q+" "+b),a.val()?c():d()}),m.child("enabled").on("value",function(a){if(a.val()==k)a.val()?c():d();else{var b=a.val()?"enabled":"disabled";console.log("Channel "+b+": "+t+" "+q)}})}function c(){k=!0,n.child("enabled").set(!0),m.child("enabled").set(!0)}function d(){k=!1,n.child("enabled").set(!1),m.child("enabled").set(!1)}function e(){return k}function f(a){var b=function(b){if(e){var c=b.val();console.log("Data read from "+t+" "+q+": "+c),a(c)}else a(l)};m.child("data").once("value",b)}function g(a){var b=function(b){console.log("Datachange event. Channel enabled: "+e()),e()&&a(b.val())};m.child("data").on("value",b)}function i(){m.child("data").off("value")}function j(a){e()?m.child("data").set(a):console.log("Could not set data. Channel is disabled.")}var k,l,m,n,o={dataFormat:"midi"},p=h(o,a),q=p.name,t=p.type,u=p.dataFormat;this.setData=j,this.disconnect=i,this.getData=f,this.enable=c,this.disable=d,this.isEnabled=e,this.watch=g,b(),f(function(a){l=a})}function l(a,b){function c(a){g.child("statusLog").push(a),g.child("statusDescription").add(f.statusMessages[a]?f.statusMessages[a]:"Unknown status")}function d(a){a&&(g.child("status").push(a),g.child("statusDescription").set(f.statusMessages[a]?f.statusMessages[a]:"Unknown status"),f.logEnabled&&c(a))}var e={statusMessages:{},logEnabled:!0},f=h(e,b),g=r.child("moduleStatus").child(a);this.set=d}var m,n,o=a.name,p=a.url,q=a.id,r=new Firebase(p+"/metadata/"+q),s={};return function(){return c()?(m=new l(b.name,b.statusMessages),r.child("name").set(o),r.child("isTurnedOn").set(!0),d(["isTurnedOn","moduleStatus"]),r.once("value",e),void r.child("api").on("value",f)):!1}(),s.getMetadata=i,s.onReady=j,s.Channel=k,s.Status=l,s}Tao.VERSION="0.0.1";