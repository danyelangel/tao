/*! tao 27-08-2015 */
"use strict";function Tao(a,b){function c(){return d()?(n=new m(b.name,b.statusMessages),s.child("name").set(p),s.child("isTurnedOn").set(!0),e(["isTurnedOn","moduleStatus"]),s.once("value",f),void s.child("api").on("value",g)):!1}function d(){return"string"!=typeof a.name||a.name.length<4?(h("name"),!1):"string"!=typeof a.url||a.url.length<10?(h("url"),!1):"string"!=typeof a.id||20!=a.id.length?(h("id"),!1):!0}function e(a){a.map(function(a){s.child(a).onDisconnect().remove()})}function f(a){var b=a.child("input").val(),c=a.child("output").val();t._outputRef=new Firebase(q+"/channels/"+c),t._inputRef=new Firebase(q+"/channels/"+b),t.onReadyCallback(a.val()),o=new m("tao",{})}function g(a){a.val()&&(b.api(s.child("api"),a.val()),n.set(a.val()))}function h(a){console.log("*** TaoConnect has encountered an error: "+a+" ***")}function i(a,b){var c,d={};for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(d[c]=a[c]);for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(d[c]=b[c]);return d}function j(a){s.once("value",a)}function k(a){t.onReadyCallback=a}function l(a){function b(){"input"==u?m=t._inputRef.child(v).child(r):"output"==u&&(m=t._outputRef.child(v).child(r)),n=s.child("channels").child(u).child(r),c(),n.child("enabled").on("value",function(a){var b=a.val()?"enabled":"disabled";console.log("Channel "+u+" "+r+" "+b),a.val()?c():d()}),m.child("enabled").on("value",function(a){if(a.val()==k)a.val()?c():d();else{var b=a.val()?"enabled":"disabled";console.log("Channel "+b+": "+u+" "+r)}})}function c(){k=!0,n.child("enabled").set(!0),m.child("enabled").set(!0)}function d(){k=!1,n.child("enabled").set(!1),m.child("enabled").set(!1)}function e(){return k}function f(a){var b=function(b){if(e()){var c=b.val();console.log("Data read from "+u+" "+r+": "+c),a(c)}else a(l)};m.child("data").once("value",b)}function g(a){var b=function(b){console.log("Datachange event. Channel enabled: "+e()),e()&&(a(b.val()),o.set("libraryfetch"))};m.child("data").on("value",b)}function h(){m.child("data").off("value")}function j(a){e()?m.child("data").set(a):console.log("Could not set data. Channel is disabled.")}var k,l,m,n,p={dataFormat:"midi"},q=i(p,a),r=q.name,u=q.type,v=q.dataFormat;this.setData=j,this.disconnect=h,this.getData=f,this.enable=c,this.disable=d,this.isEnabled=e,this.watch=g,b(),f(function(a){l=a})}function m(a,b){function c(a){var b=new Date;g.child("statusLog").child(b.toString()).set(a)}function d(a){a&&(g.child("status").set(a),g.child("statusDescription").set(f.statusMessages[a]?f.statusMessages[a]:"Unknown status"),f.logEnabled&&c(a))}var e={statusMessages:{},logEnabled:!0},f=i(e,b),g=s.child("moduleStatus").child(a);this.set=d}var n,o,p=a.name,q=a.url,r=a.id,s=new Firebase(q+"/metadata/"+r),t={};return t.getMetadata=j,t.onReady=k,t.Channel=l,t.Status=m,c(),t}Tao.VERSION="0.0.1";